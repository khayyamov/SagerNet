name: NaïveProxy Plugin Release Build

on:
  push:
jobs:
  check:
    name: Check Access
    runs-on: ubuntu-latest
    steps:
      - name: "Check access"
        uses: "lannonbr/repo-permission-check-action@2.0.2"
        with:
          permission: "write"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  native:
    runs-on: ubuntu-latest
    name: Native Build (NaïveProxy)
    strategy:
      fail-fast: false
      matrix:
        arch: [ armeabi-v7a, arm64-v8a, x86, x86_64 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Fetch Status
        run: git submodule status 'plugin/naive/*' > naive_status
      - name: Naive Cache
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            plugin/naive/src/main/jniLibs/${{ matrix.arch }}
          key: naive-${{ matrix.arch }}-${{ hashFiles('bin/plugin/naive/*', 'naive_status') }}
      - name: Gradle cache
        uses: actions/cache@v3
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ~/.gradle
          key: native-${{ hashFiles('**/*.gradle.kts') }}
      - name: Native Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "sdk.dir=${ANDROID_HOME}" > local.properties
          echo "ndk.dir=${ANDROID_HOME}/ndk/25.0.8775105" >> local.properties
          ./run init action naive
          ./run plugin naive init
          ./run plugin naive ${{ matrix.arch }}

  publish:
    runs-on: ubuntu-latest
    name: Upload Artifact
    steps:
      - name: Create ZIP file
        run: zip -r naive_so_files.zip plugin/naive/src/main/jniLibs
        # Optionally, you can store the created artifact as a workflow artifact
        # So that it can be used in later steps or manually downloaded from the GitHub UI
        # - uses: actions/upload-artifact@v2
        #   with:
        #     name: naive_so_files
        #     path: naive_so_files.zip

      - name: Upload Artifact
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: naive_so_files.zip
          tag: ${{ github.ref }}
          file_glob: true
